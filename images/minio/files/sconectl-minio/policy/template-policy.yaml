name: {{session}}
version: "0.3.10"
predecessor: {{predecessor}}

access_policy: $$SCONE::access_policy$$

creator:
  {{session_creator}}

security: $$SCONE::security_policy$$

services:
  #####
  # server policy
  - name: minio
    image_name: app_image
    command: minio server /minio-data/data --anonymous --address "{{mnServiceAddress}}" --console-address "{{mnConsoleAddress}}"
    # mig 29jul2025
    # parameter fspf_update_policy is only available from 0.3.11
    #fspf_update_policy: no_rollback_protection
    environment:
      #####
      # application configuration
      MC_CONFIG_DIR:                 /minio-data/.mc
      MINIO_ACCESS_KEY_FILE:         access_key
      MINIO_SECRET_KEY_FILE:         secret_key
      MINIO_ROOT_USER_FILE:          access_key
      MINIO_ROOT_PASSWORD_FILE:      secret_key
      MINIO_KMS_SECRET_KEY_FILE:     kms_master_key
      MINIO_UPDATE_MINISIGN_PUBKEY:  RWTx5Zr1tiHQLwG9keckT0c45M3AGeHD6IvimQHpyRywVWGbP1aVSGav
      MINIO_CONFIG_ENV_FILE:         config.env
      MINIO_ROOT_USER:               minioroot
      MINIO_ROOT_PASSWORD:           .........
      PATH:                          /usr/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/sbin:/bin
      HOME:                          /root

      #####
      # SCONE configuration
      SCONE_ALLOW_DLOPEN:            "{{mnSconeAllowDlOpen}}"
      SCONE_SYSLIBS:                 "1"
      SCONE_HEAP:                    {{mnSconeHeap}}
      SCONE_MPROTECT:                "1"
      SCONE_PROCFS_WHITELIST:        mounts:self/mounts:meminfo:vmstat:loadavg:diskstats

# FSPF environment variable for continued operation
      SCONE_FSPF_MUTABLE:            1
      SCONE_FSS_VERIFICATION_ERROR:  eio

    attestation:
      - $$SCONE::attestation_service$$
    pwd: /


  #####
  # client policy
  - name: mcaliasset
    image_name: cli_image
    command: mc server /minio-data/data --anonymous --address "{{mnServiceAddress}}" --console-address "{{mnConsoleAddress}}"

###
# services images: configurations, files and secret injections for each service
# - app_image: Keycloak configurations
# - transformer_image: Saver.* and PKCS generator configurations
images:
  - name: app_image
    volumes:
      - name: set_1_minio_datadir_volume
        path: /minio-data

secrets:
  - name: access_policy
    import:
      session: {{access_policy_name}}
      secret: access_policy 
      cas_url: {{cas.access.cas_url}}
      cas_key: {{cas.access.cas_key}}
  - name: security_policy 
    import:
      session: {{security_policy_name}}
      secret: security_policy
      cas_url: {{cas.security.cas_url}}
      cas_key: {{cas.security.cas_key}}
  - name: SCONE_SESSION_ID_
    kind: ascii
    value: "{{RANDOM}}"

  - name: attestation_service
    import:
      session: {{image_policy_name}}
      secret: mrsigner_mrenclave_versions
      cas_url: {{cas.image.cas_url}}
      cas_key: {{cas.image.cas_key}}

volumes:
  # No fspf key and tag: an encrypted volume will be automatically generated by CAS
  - name: set_1_minio_datadir_volume
